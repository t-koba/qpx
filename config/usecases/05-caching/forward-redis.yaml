version: 1
state_dir: "${QPX_STATE_DIR:-~/.local/share/qpx}"

cache:
  backends:
    - name: redis-local
      kind: redis
      endpoint: "redis://127.0.0.1:6379/0"
      timeout_ms: 1200
      max_object_bytes: 1048576

listeners:
  - name: forward
    mode: forward
    listen: "127.0.0.1:8080"
    default_action: { type: block }
    cache:
      enabled: true
      backend: redis-local
      namespace: "forward-default"
      default_ttl_secs: 60
      max_object_bytes: 1048576
    rules:
      - name: no-cache-for-api
        match:
          src_ip: ["127.0.0.1/32", "::1/128"]
          method: ["GET", "HEAD"]
          host: ["api.example.com"]
        action: { type: direct }
        headers:
          request_set:
            Cache-Control: "no-store"
      - name: allow-loopback-cacheable
        match:
          src_ip: ["127.0.0.1/32", "::1/128"]
          method: ["GET", "HEAD"]
          host: ["*"]
        action: { type: direct }
