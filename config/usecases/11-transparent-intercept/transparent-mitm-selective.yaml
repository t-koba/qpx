version: 1
state_dir: "${QPX_STATE_DIR:-~/.local/share/qpx}"
listeners:
  - name: transparent-mitm
    mode: transparent
    listen: "0.0.0.0:15003"
    default_action: { type: block }
    tls_inspection:
      enabled: true
      verify_upstream: true
      verify_exceptions: ["*.internal.example.com"]
    rules:
      - name: inspect-dev-traffic
        match:
          src_ip: ["127.0.0.1/32", "::1/128", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
          sni: ["*.dev.example.com", "api.stage.example.com"]
        action: { type: inspect }
      - name: tunnel-pinned
        match:
          src_ip: ["127.0.0.1/32", "::1/128", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
          sni: ["*.bank.example", "*.payments.example"]
        action: { type: tunnel }
      - name: block-bad-dns
        match:
          src_ip: ["127.0.0.1/32", "::1/128", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
          host: ["*.malware.test", "*.botnet.invalid"]
        action: { type: block }
      - name: allow-private-tunnel
        match:
          src_ip: ["127.0.0.1/32", "::1/128", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16"]
          dst_port: [80, 443]
          host: ["*"]
        action: { type: tunnel }
