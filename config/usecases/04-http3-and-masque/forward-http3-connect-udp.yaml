version: 1
state_dir: "${QPX_STATE_DIR:-~/.local/share/qpx}"

# WARNING: This is a sample config. Do not expose it to untrusted networks as-is.
# - Binds default to loopback; set QPX_FORWARD_LISTEN/QPX_FORWARD_H3_LISTEN explicitly if publishing.
# - Replace auth.users passwords before use.
listeners:
  - name: forward-http3
    mode: forward
    listen: "${QPX_FORWARD_LISTEN:-127.0.0.1:8080}"
    default_action:
      type: block
    http3:
      enabled: true
      # HTTP/3 forward listener (QUIC+TLS). A server cert is issued from the local CA state.
      listen: "${QPX_FORWARD_H3_LISTEN:-127.0.0.1:8443}"
      connect_udp:
        enabled: true
        idle_timeout_secs: 45
        max_capsule_buffer_bytes: 262144
    rules:
      - name: connect-udp-chain-corp
        match:
          method: ["CONNECT"]
          host: ["*.corp.example"]
        auth:
          require: ["local"]
        action:
          type: proxy
          upstream: masque-chain
      - name: block-ads
        match:
          host: ["*.doubleclick.net", "*.googlesyndication.com", "*.adservice.google.com"]
        action:
          type: block
      - name: http-require-auth
        match:
          method: ["GET", "HEAD", "POST", "PUT", "DELETE", "OPTIONS"]
        auth:
          require: ["local"]
        action:
          type: direct
      - name: connect-require-auth
        match:
          method: ["CONNECT"]
        auth:
          require: ["local"]
        action:
          type: direct

auth:
  users:
    - username: tester
      password: change-me

upstreams:
  - name: masque-chain
    # CONNECT-UDP upstream chaining currently expects an HTTP/3-capable proxy URL.
    url: "https://masque-gateway.example.com:443"
